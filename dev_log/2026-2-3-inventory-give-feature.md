# 背包道具给予功能

## 更新日期
2026-2-3

## 功能概述
在角色背包界面添加了道具给予功能，允许玩家将道具从一个角色转移到队伍中的其他角色。

## 功能特点

### 1. 给予按钮
- ✅ 在每个道具卡片的操作区域添加了"给予"按钮
- ✅ 按钮使用橙色主题，与其他操作按钮区分
- ✅ 点击后打开目标选择弹窗

### 2. 目标选择弹窗
- ✅ 显示所有可用的目标单位（队伍中的其他角色）
- ✅ 自动排除：
  - 自己（不能给自己）
  - 已死亡的单位
  - 非玩家单位（只能在玩家队伍内转移）
- ✅ 显示目标角色的头像和背包信息
- ✅ 点击目标角色即可完成转移

### 3. 堆叠道具支持
- ✅ 对于可堆叠道具，可以选择给予数量
- ✅ 提供数量输入框，限制在1到当前堆叠数量之间
- ✅ 显示当前可用数量

### 4. 交互反馈
- ✅ 转移成功后显示提示消息
- ✅ 自动更新双方背包显示
- ✅ 转移失败时回滚操作并提示

## 使用方法

### 基本流程
1. 打开角色详情面板
2. 切换到"背包"标签
3. 找到要给予的道具
4. 点击道具的"**给予**"按钮
5. 在弹出的窗口中选择目标角色
6. 如果是堆叠道具，可以调整给予数量
7. 点击目标角色完成转移

### 示例场景

#### 场景1：给予单个道具
```
1. 玩家A有一把"铁剑"
2. 点击铁剑的[给予]按钮
3. 选择玩家B
4. 铁剑从玩家A转移到玩家B
```

#### 场景2：给予部分堆叠道具
```
1. 玩家A有15个"生命药水"
2. 点击生命药水的[给予]按钮
3. 调整数量为5
4. 选择玩家B
5. 5个药水转移到玩家B，玩家A剩余10个
```

#### 场景3：智能堆叠
```
1. 玩家A有10个"魔力药水"
2. 玩家B已有5个"魔力药水"（最大堆叠99）
3. 给予10个药水到玩家B
4. 玩家B的魔力药水自动合并为15个
```

## UI设计

### 给予按钮
- **颜色**: 橙色 (#ff9800)
- **位置**: 在使用、装备按钮之后，丢弃按钮之前
- **悬停效果**: 背景变为橙色

### 目标选择弹窗
- **背景**: 深紫色渐变，橙色边框
- **布局**: 垂直列表
- **卡片样式**: 
  - 显示角色头像（圆形）
  - 显示角色名称（金色）
  - 显示背包道具数量
  - 悬停时高亮和右移效果

### 数量选择器（堆叠道具）
- **输入框**: 带橙色边框的数字输入框
- **限制**: 自动限制在有效范围内
- **显示**: 显示"/ 最大数量"提示

## 技术实现

### 新增状态
```typescript
const giveTargetItem = ref<Item | null>(null);  // 要给予的道具
const giveStackAmount = ref<number>(1);          // 给予数量
```

### 核心方法

#### 获取可用目标
```typescript
const availableTargets = computed(() => {
  return map.sprites.filter((unit: Unit) => 
    unit.party === 'player' && 
    unit.id !== props.unit?.id &&
    unit.state !== 'dead'
  );
});
```

#### 开始给予流程
```typescript
const giveItem = (item: Item) => {
  giveTargetItem.value = item;
  giveStackAmount.value = item.stackCount;
};
```

#### 确认给予
```typescript
const confirmGive = async (target: Unit) => {
  // 1. 移除道具
  const removedItem = props.unit.removeItem(item.uid, amount);
  
  // 2. 添加到目标
  const success = target.addItem(removedItem);
  
  // 3. 失败则回滚
  if (!success) {
    props.unit.addItem(removedItem);
  }
};
```

## 依赖系统

### 使用的核心API
- `Unit.removeItem(uid, amount)` - 移除道具
- `Unit.addItem(item)` - 添加道具（自动处理堆叠）
- `MessageTipSystem.showMessage()` - 显示提示信息
- `golbalSetting.map.sprites` - 获取所有单位

### 导入的工具
```typescript
import { golbalSetting } from '@/core/golbalSetting';
import { getUnitAvatar } from '@/utils/utils';
```

## 边界情况处理

### 1. 目标背包已满
- 转移失败
- 道具退回原背包
- 显示错误提示

### 2. 无效数量
- 检查数量是否 > 0
- 检查数量是否 <= 当前堆叠数
- 显示错误提示

### 3. 没有可用目标
- 显示"没有可用的目标单位"
- 提示只能在队伍内转移

### 4. 操作中断
- 点击弹窗外部可关闭
- 点击关闭按钮可取消
- 不影响原有道具状态

## 用户体验优化

### 1. 视觉反馈
- 按钮悬停效果
- 目标卡片悬停高亮
- 平滑的动画过渡

### 2. 信息提示
- 清晰显示要给予的道具和数量
- 显示目标角色的背包状态
- 操作结果的消息提示

### 3. 操作便捷性
- 一键给予（默认全部数量）
- 快速数量调整
- 单击目标即可完成

## 未来扩展可能

### 可能的改进方向
1. **批量给予**: 支持一次给予多个道具
2. **交易系统**: 双向道具交换
3. **拖拽操作**: 拖放道具到目标角色
4. **数量快捷键**: 快速选择1/2、全部等
5. **交易历史**: 记录道具转移日志
6. **权限控制**: 某些道具不可交易
7. **距离限制**: 只能给附近的角色

## 测试建议

### 测试用例
1. ✅ 给予非堆叠道具（武器、护甲）
2. ✅ 给予部分堆叠道具（药水）
3. ✅ 给予全部堆叠道具
4. ✅ 目标背包满时的处理
5. ✅ 自动堆叠合并功能
6. ✅ 取消操作
7. ✅ 没有可用目标时的显示

### 测试方法
```javascript
// 浏览器控制台
import { addTestItemsToAllPlayers } from '@/components/CharacterDetailPannel/pages/InventoryTestUtil'
addTestItemsToAllPlayers()

// 然后打开任意角色的背包，测试给予功能
```

## 相关文件

### 修改的文件
- `src/components/CharacterDetailPannel/pages/CreatureInventory.vue`
  - 添加给予按钮
  - 添加目标选择弹窗
  - 实现给予逻辑
  - 添加相关样式

### 相关文档
- `dev_log/INVENTORY_README.md` - 背包系统总体说明
- `dev_log/INVENTORY_QUICK_START.md` - 背包快速使用指南
- `dev_log/item-README.md` - 道具系统核心说明

## 注意事项

1. **存档兼容**: 道具转移会自动保存到游戏存档
2. **多人模式**: 当前仅支持单人游戏，多人模式需额外考虑同步
3. **性能**: 道具转移是同步操作，大量转移不会影响性能
4. **安全性**: 所有操作都有验证，防止数据丢失

## 总结

道具给予功能为玩家提供了灵活的资源管理方式，让队伍成员之间可以互相支援。该功能与现有的道具系统无缝集成，使用简单直观，为游戏增加了更多的策略性和互动性。

---

**功能状态**: ✅ 已完成并测试
**版本**: 1.0
**作者**: GitHub Copilot
**日期**: 2026-2-3
