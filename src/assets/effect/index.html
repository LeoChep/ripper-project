<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§†é¢‘å¸§æå–å·¥å…·</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

<div id="upload-section">
  <h3>ä¸Šä¼ è§†é¢‘æ–‡ä»¶</h3>
  <input type="file" id="videoUpload" accept="video/*,.mov,.MOV,.mp4,.MP4,.webm,.WEBM,.avi,.AVI,.mkv,.MKV" />
  <button id="uploadBtn">ä¸Šä¼ è§†é¢‘</button>
  <div class="format-info">
    <small>ğŸ’¡ æ”¯æŒæ ¼å¼ï¼šMP4ã€MOVã€WEBMã€AVIã€MKVã€OGG</small>
    <br>
    <small>ğŸ¬ MOVæ ¼å¼æç¤ºï¼šæ”¯æŒé€æ˜é€šé“æå–ï¼Œå»ºè®®ä½¿ç”¨H.264ç¼–ç </small>
  </div>
</div>

<div id="test-video-section">
  <h3>ğŸ¬ ç”Ÿæˆæµ‹è¯•è§†é¢‘</h3>
  <div class="test-video-controls">
    <p>æ²¡æœ‰MOVæ–‡ä»¶ï¼Ÿç”Ÿæˆä¸€ä¸ªç”¨äºæµ‹è¯•çš„è§†é¢‘ï¼š</p>
    <div class="test-options">
      <div class="option-group">
        <label>èƒŒæ™¯è‰²ï¼š</label>
        <select id="testBgColor">
          <option value="#00ff00">ç»¿è‰² (æ ‡å‡†ç»¿å¹•)</option>
          <option value="#0000ff">è“è‰² (è“å¹•)</option>
          <option value="#ff00ff">å“çº¢è‰²</option>
          <option value="#ffffff">ç™½è‰²</option>
          <option value="#000000">é»‘è‰²</option>
        </select>
      </div>
      
      <div class="option-group">
        <label>åŠ¨ç”»å¯¹è±¡ï¼š</label>
        <select id="testAnimation">
          <option value="circle">ç§»åŠ¨çš„åœ†åœˆ</option>
          <option value="square">æ—‹è½¬çš„æ–¹å—</option>
          <option value="text">æ»šåŠ¨æ–‡å­—</option>
        </select>
      </div>
      
      <div class="option-group">
        <label>æ—¶é•¿ï¼š</label>
        <select id="testDuration">
          <option value="3">3ç§’</option>
          <option value="5">5ç§’</option>
          <option value="10">10ç§’</option>
        </select>
      </div>
      
      <div class="option-group">
        <label>è¾“å‡ºæ ¼å¼ï¼š</label>
        <select id="testFormat">
          <option value="mp4">MP4 (æ¨è)</option>
          <option value="webm">WebM</option>
        </select>
      </div>
    </div>
    
    <div class="format-note">
      <small>ğŸ“ å…³äºMOVæ ¼å¼ï¼š</small><br>
      <small>â€¢ æµè§ˆå™¨MediaRecorderä¸ç›´æ¥æ”¯æŒMOVæ ¼å¼è¾“å‡º</small><br>
      <small>â€¢ ç”ŸæˆMP4æ ¼å¼ï¼Œå¯ç”¨è½¬æ¢å·¥å…·è½¬ä¸ºMOVï¼š<code>ffmpeg -i input.mp4 output.mov</code></small><br>
      <small>â€¢ æˆ–ä½¿ç”¨åœ¨çº¿è½¬æ¢æœåŠ¡å°†MP4è½¬æ¢ä¸ºMOVæ ¼å¼</small>
    </div>
    
    <button id="generateTestBtn">ğŸ¥ ç”Ÿæˆæµ‹è¯•è§†é¢‘</button>
    <span id="generateStatus"></span>
  </div>
</div>

<div id="chroma-key-section" style="display: none;">
  <h3>ğŸ¨ è‰²é”®é€æ˜è®¾ç½®</h3>
  <div class="chroma-controls">
    <div class="control-group">
      <label for="enableChromaKey">
        <input type="checkbox" id="enableChromaKey"> å¯ç”¨è‰²é”®é€æ˜
      </label>
    </div>
    
    <div class="control-group" id="chromaKeyOptions" style="display: none;">
      <div class="color-picker-group">
        <label for="chromaKeyColor">èƒŒæ™¯è‰²:</label>
        <input type="color" id="chromaKeyColor" value="#00ff00">
        <span class="color-preview" id="colorPreview"></span>
        <button id="pickColorBtn" type="button">ğŸ¯ ä»è§†é¢‘é€‰å–</button>
      </div>
      
      <div class="slider-group">
        <label for="chromaKeyTolerance">å®¹å·® (0-100): <span id="toleranceValue">10</span></label>
        <input type="range" id="chromaKeyTolerance" min="0" max="100" value="10">
      </div>
      
      <div class="slider-group">
        <label for="chromaKeySoftness">ç¾½åŒ– (0-50): <span id="softnessValue">2</span></label>
        <input type="range" id="chromaKeySoftness" min="0" max="50" value="2">
      </div>
    </div>
    
    <div class="preset-colors">
      <span>å¸¸ç”¨èƒŒæ™¯è‰²:</span>
      <button class="color-preset" data-color="#00ff00" style="background: #00ff00;" title="ç»¿å¹•">ç»¿</button>
      <button class="color-preset" data-color="#0000ff" style="background: #0000ff;" title="è“å¹•">è“</button>
      <button class="color-preset" data-color="#ff00ff" style="background: #ff00ff;" title="å“çº¢">å“çº¢</button>
      <button class="color-preset" data-color="#ffffff" style="background: #ffffff;" title="ç™½è‰²">ç™½</button>
      <button class="color-preset" data-color="#000000" style="background: #000000;" title="é»‘è‰²">é»‘</button>
    </div>
  </div>
</div>

<div id="video-container">
  <video id="vid" style="background: red;" crossorigin="anonymous" muted playsinline controls></video>
  <div id="crop-overlay"></div>
</div>
<canvas id="canvas"></canvas>

<div id="controls">
  <button id="startBtn" disabled>å¼€å§‹æå–å¸§</button>
  <button id="stopBtn" disabled>åœæ­¢æå–</button>
  <button id="downloadBtn" disabled>ä¸‹è½½æå–çš„å¸§</button>
  <button id="cropBtn" disabled>âœ‚ï¸ è®¾ç½®è£å‰ªåŒºåŸŸ</button>
  <span id="status">è¯·å…ˆä¸Šä¼ è§†é¢‘æ–‡ä»¶</span>
</div>

<div id="crop-section" style="display: none;">
  <h4>ğŸ¯ è£å‰ªè®¾ç½®</h4>
  <div class="crop-controls">
    <label>è£å‰ªæ¨¡å¼ï¼š</label>
    <select id="cropMode">
      <option value="none">æ— è£å‰ªï¼ˆå®Œæ•´è§†é¢‘ï¼‰</option>
      <option value="manual">æ‰‹åŠ¨é€‰æ‹©åŒºåŸŸ</option>
      <option value="center">å±…ä¸­è£å‰ª</option>
    </select>
  </div>
  
  <div id="manual-crop" style="display: none;">
    <p><strong>ğŸ¯ æŒ‰Fé”®å¼€å§‹è£å‰ª</strong>ï¼Œç„¶åä½¿ç”¨æ–¹å‘é”®è°ƒæ•´é€‰æ‹©åŒºåŸŸï¼š</p>
    <div class="crop-usage-tip">
      <small>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</small><br>
      <small>â€¢ æŒ‰<kbd>F</kbd>é”®å¼€å§‹è£å‰ªæ¨¡å¼</small><br>
      <small>â€¢ ä½¿ç”¨<kbd>æ–¹å‘é”®</kbd>ç§»åŠ¨è£å‰ªåŒºåŸŸ</small><br>
      <small>â€¢ æŒ‰ä½<kbd>Shift</kbd> + æ–¹å‘é”®è°ƒæ•´å¤§å°</small><br>
      <small>â€¢ æŒ‰<kbd>Enter</kbd>ç¡®è®¤é€‰æ‹©ï¼Œ<kbd>Esc</kbd>å–æ¶ˆ</small>
    </div>
    <div class="crop-info">
      <span>é€‰æ‹©åŒºåŸŸï¼š</span>
      <span id="cropInfo">æœªè®¾ç½®</span>
      <button id="resetCrop">é‡ç½®é€‰æ‹©</button>
    </div>
  </div>
  
  <div id="center-crop" style="display: none;">
    <div class="crop-size-controls">
      <label>è£å‰ªå°ºå¯¸ï¼š</label>
      <input type="number" id="cropWidth" placeholder="å®½åº¦" min="50" step="10" value="400">
      <span>Ã—</span>
      <input type="number" id="cropHeight" placeholder="é«˜åº¦" min="50" step="10" value="300">
      <button id="applyCenterCrop">åº”ç”¨å±…ä¸­è£å‰ª</button>
    </div>
  </div>
</div>
<div id="progress">
  <div id="frameInfo">å¸§æ•°: 0 / æ€»æ—¶é•¿: 0s</div>
</div>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  #upload-section {
    background: #f5f5f5;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
    border: 2px dashed #ccc;
  }

  #upload-section h3 {
    margin-top: 0;
    color: #333;
  }

  .format-info {
    margin-top: 10px;
    color: #666;
    font-style: italic;
    line-height: 1.4;
  }

  .format-info small {
    background: #e8f4fd;
    padding: 5px 10px;
    border-radius: 15px;
    border: 1px solid #b3d9f2;
    display: inline-block;
    margin: 2px 0;
  }

  #videoUpload {
    margin-right: 10px;
    padding: 5px;
  }

  #controls {
    margin: 10px 0;
  }

  button {
    margin-right: 10px;
    padding: 8px 16px;
    background: #007cba;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  button:hover:not(:disabled) {
    background: #005a8b;
  }

  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  #downloadBtn {
    background: #28a745;
  }

  #downloadBtn:hover:not(:disabled) {
    background: #218838;
  }

  #status {
    font-weight: bold;
    color: #333;
  }

  #progress {
    margin-top: 10px;
  }

  canvas {
    border: 1px solid #ccc;
    max-width: 100%;
  }

  #test-video-section {
    margin: 20px 0;
    padding: 15px;
    background: #fff3cd;
    border-radius: 5px;
    border: 1px solid #ffeaa7;
  }

  .test-video-controls {
    margin-top: 10px;
  }

  .test-options {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin: 10px 0;
  }

  .option-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .option-group label {
    font-weight: bold;
    color: #6c757d;
  }

  .option-group select {
    padding: 5px 10px;
    border: 1px solid #ced4da;
    border-radius: 3px;
    background: white;
  }

  #generateTestBtn {
    background: linear-gradient(45deg, #28a745, #20c997);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    margin: 10px 5px 0 0;
    transition: all 0.3s;
  }

  #generateTestBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
  }

  #generateTestBtn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
  }

  #generateStatus {
    color: #28a745;
    font-weight: bold;
    margin-left: 10px;
  }

  .format-note {
    background: #e7f3ff;
    padding: 10px;
    border-radius: 4px;
    border-left: 4px solid #007cba;
    margin: 10px 0;
    font-size: 12px;
    line-height: 1.4;
  }

  .format-note code {
    background: #f1f1f1;
    padding: 2px 4px;
    border-radius: 2px;
    font-family: 'Courier New', monospace;
  }

  #crop-section {
    margin: 20px 0;
    padding: 15px;
    background: #f0f8ff;
    border-radius: 5px;
    border: 1px solid #b0d4f1;
  }

  .crop-controls {
    margin: 10px 0;
  }

  .crop-controls label {
    font-weight: bold;
    margin-right: 10px;
  }

  .crop-controls select {
    padding: 5px 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    background: white;
  }

  .crop-info {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    padding: 8px;
    background: #fff;
    border-radius: 3px;
    border: 1px solid #ddd;
  }

  .crop-usage-tip {
    background: #fff9c4;
    border: 1px solid #f7d794;
    border-radius: 4px;
    padding: 8px;
    margin: 8px 0;
    font-style: italic;
    color: #8e6a00;
  }

  .crop-usage-tip kbd {
    background: #f4f4f4;
    border: 1px solid #ccc;
    border-radius: 3px;
    padding: 2px 6px;
    font-family: monospace;
    font-weight: bold;
    color: #333;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }

  .crop-size-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
  }

  .crop-size-controls input {
    width: 80px;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
  }

  #cropBtn {
    background: linear-gradient(45deg, #ff6b6b, #ffa500);
  }

  #cropBtn:hover:not(:disabled) {
    background: linear-gradient(45deg, #ff5252, #ff9800);
    transform: translateY(-1px);
  }

  #resetCrop {
    background: #dc3545;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
  }

  #applyCenterCrop {
    background: #28a745;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 3px;
    cursor: pointer;
  }

  /* è£å‰ªé€‰æ‹©æ¡†æ ·å¼ */
  #video-container {
    position: relative;
    display: inline-block;
    border: 2px solid #007cba;
    border-radius: 5px;
    overflow: hidden;
  }

  #crop-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
  }

  #vid {
    display: block;
    position: relative;
    z-index: 1;
  }

  .crop-selection {
    position: absolute;
    border: 2px dashed #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
    pointer-events: none;
  }

  .crop-handle {
    position: absolute;
    width: 8px;
    height: 8px;
    background: #ff6b6b;
    border: 1px solid #fff;
    cursor: nw-resize;
  }

  video {
    max-width: 100%;
    margin: 10px 0;
  }

  /* è‰²é”®åŠŸèƒ½æ ·å¼ */
  #chroma-key-section {
    background: #f0f8ff;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
    border: 2px solid #b3d9f2;
  }

  #chroma-key-section h3 {
    margin-top: 0;
    color: #0066cc;
  }

  .chroma-controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .control-group label {
    font-weight: bold;
    min-width: 80px;
  }

  .color-picker-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .color-preview {
    width: 30px;
    height: 30px;
    border: 2px solid #ccc;
    border-radius: 4px;
    display: inline-block;
    background: var(--preview-color, #00ff00);
  }

  .slider-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .slider-group label {
    font-size: 14px;
    color: #333;
  }

  .slider-group input[type="range"] {
    width: 200px;
  }

  .preset-colors {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .color-preset {
    width: 40px;
    height: 40px;
    border: 2px solid #333;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
    color: transparent;
    transition: all 0.2s;
  }

  .color-preset:hover {
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  #pickColorBtn {
    background: #ff6b35;
    font-size: 12px;
    padding: 5px 10px;
  }

  #pickColorBtn:hover:not(:disabled) {
    background: #ff4500;
  }

  #chromaKeyOptions {
    background: rgba(255, 255, 255, 0.5);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
  }
</style>

<script>
  const video = document.getElementById('vid');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha: true }); // âœ… å¯ç”¨Alpha
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const videoUpload = document.getElementById('videoUpload');
  const status = document.getElementById('status');
  const frameInfo = document.getElementById('frameInfo');
  
  // è‰²é”®åŠŸèƒ½å…ƒç´ 
  const chromaKeySection = document.getElementById('chroma-key-section');
  const enableChromaKey = document.getElementById('enableChromaKey');
  const chromaKeyOptions = document.getElementById('chromaKeyOptions');
  const chromaKeyColor = document.getElementById('chromaKeyColor');
  const chromaKeyTolerance = document.getElementById('chromaKeyTolerance');
  const chromaKeySoftness = document.getElementById('chromaKeySoftness');
  const colorPreview = document.getElementById('colorPreview');
  const toleranceValue = document.getElementById('toleranceValue');
  const softnessValue = document.getElementById('softnessValue');
  const pickColorBtn = document.getElementById('pickColorBtn');
  const colorPresets = document.querySelectorAll('.color-preset');
  
  // è£å‰ªåŠŸèƒ½å…ƒç´ 
  const cropBtn = document.getElementById('cropBtn');
  const cropSection = document.getElementById('crop-section');
  const cropMode = document.getElementById('cropMode');
  const manualCrop = document.getElementById('manual-crop');
  const centerCrop = document.getElementById('center-crop');
  const cropInfo = document.getElementById('cropInfo');
  const resetCrop = document.getElementById('resetCrop');
  const cropWidth = document.getElementById('cropWidth');
  const cropHeight = document.getElementById('cropHeight');
  const applyCenterCrop = document.getElementById('applyCenterCrop');
  const videoContainer = document.getElementById('video-container');
  const cropOverlay = document.getElementById('crop-overlay');
  
  let nowFrame = 0;
  let frameCount = 0;
  let isExtracting = false;
  let fps = 18; // é»˜è®¤FPSï¼Œä¼šåœ¨è§†é¢‘åŠ è½½åæ›´æ–°
  let extractedFrames = []; // å­˜å‚¨æå–çš„å¸§æ•°æ®
  let isPickingColor = false; // æ˜¯å¦æ­£åœ¨æ‹¾è‰²æ¨¡å¼

  // è£å‰ªç›¸å…³å˜é‡
  let cropArea = null; // è£å‰ªåŒºåŸŸ {x, y, width, height}
  let isDragging = false;
  let dragStart = {x: 0, y: 0};
  let currentCropMode = 'none';
  let cropSelection = null;
  let isAltPressed = false; // å…¨å±€Alté”®çŠ¶æ€

  // ä¸Šä¼ è§†é¢‘å¤„ç†
  uploadBtn.onclick = () => {
    const file = videoUpload.files[0];
    if (!file) {
      alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶');
      return;
    }

    // æ”¯æŒçš„è§†é¢‘æ ¼å¼
    const supportedFormats = [
      'video/mp4', 'video/webm', 'video/ogg', 'video/avi',
      'video/mov', 'video/quicktime', 'video/x-msvideo',
      'video/mkv', 'video/x-matroska'
    ];
    
    const fileName = file.name.toLowerCase();
    const fileExtension = fileName.split('.').pop();
    const supportedExtensions = ['mp4', 'webm', 'ogg', 'avi', 'mov', 'mkv'];
    
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹æˆ–æ‰©å±•å
    const isValidType = file.type && supportedFormats.some(format => file.type.includes(format.split('/')[1]));
    const isValidExtension = supportedExtensions.includes(fileExtension);
    
    if (!file.type.startsWith('video/') && !isValidType && !isValidExtension) {
      alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶\næ”¯æŒæ ¼å¼ï¼šMP4, MOV, WEBM, AVI, MKV, OGG');
      return;
    }

    const url = URL.createObjectURL(file);
    video.src = url;
    video.load();
    
    status.textContent = `æ­£åœ¨åŠ è½½${fileExtension.toUpperCase()}è§†é¢‘...`;
    extractedFrames = []; // æ¸…ç©ºä¹‹å‰çš„å¸§æ•°æ®
    downloadBtn.disabled = true;
    
    // æ˜¾ç¤ºè‰²é”®è®¾ç½®é¢æ¿
    chromaKeySection.style.display = 'block';
  };

  // æ–‡ä»¶é€‰æ‹©å˜åŒ–å¤„ç†
  videoUpload.onchange = () => {
    uploadBtn.disabled = !videoUpload.files[0];
  };

  // å…¨å±€é”®ç›˜ç›‘å¬ï¼ˆç”¨äºFé”®è£å‰ªåŠŸèƒ½ï¼‰
  let cropModeActive = false;
  let currentCropRect = { x: 0, y: 0, width: 200, height: 150 }; // é»˜è®¤è£å‰ªåŒºåŸŸ
  let isPressingF = false; // Fé”®æ˜¯å¦æ­£åœ¨è¢«æŒ‰ä¸‹
  let cropStartPos = { x: 0, y: 0 }; // å¼€å§‹æ‹–æ‹½çš„ä½ç½®
  
  // ç¡®ä¿é¡µé¢å¯ä»¥æ¥æ”¶é”®ç›˜äº‹ä»¶
  document.body.tabIndex = 0;
  
  // å…¨å±€é¼ æ ‡ä½ç½®è·Ÿè¸ªå˜é‡
  let lastMousePos = { x: 0, y: 0 };
  
  // æ›´æ–°é¼ æ ‡ä½ç½®ï¼ˆè½»é‡çº§è·Ÿè¸ªï¼‰
  document.addEventListener('mousemove', (e) => {
    lastMousePos.x = e.clientX;
    lastMousePos.y = e.clientY;
  });

  document.addEventListener('keydown', (e) => {
    console.log('é”®ç›˜äº‹ä»¶:', e.key, 'target:', e.target.tagName);
    
    // é˜²æ­¢åœ¨è¾“å…¥æ¡†ä¸­è§¦å‘
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      console.log('åœ¨è¾“å…¥æ¡†ä¸­ï¼Œè·³è¿‡é”®ç›˜å¤„ç†');
      return;
    }
    
    console.log('æ£€æŸ¥è£å‰ªæ¡ä»¶:', {
      currentCropMode: currentCropMode,
      videoWidth: video.videoWidth,
      videoHeight: video.videoHeight,
      videoReadyState: video.readyState
    });
    
    // å¤„ç†Fé”®æŒ‰ä¸‹ - é€‰æ‹©è£å‰ªç‚¹
    if ((e.key === 'f' || e.key === 'F') && !isPressingF) {
      console.log('Fé”®æŒ‰ä¸‹');
      if (video.videoWidth > 0) {
        console.log('è§†é¢‘å·²åŠ è½½ï¼Œå‡†å¤‡é€‰æ‹©è£å‰ªç‚¹');
        // å¦‚æœå½“å‰ä¸æ˜¯æ‰‹åŠ¨æ¨¡å¼ï¼Œè‡ªåŠ¨åˆ‡æ¢
        if (currentCropMode !== 'manual') {
          currentCropMode = 'manual';
          cropMode.value = 'manual';
          manualCrop.style.display = 'block';
          centerCrop.style.display = 'none';
          enableManualCrop();
        }
        
        isPressingF = true;
        
        if (!cropModeActive) {
          // ç¬¬ä¸€æ¬¡æŒ‰F - è®¾ç½®èµ·å§‹ç‚¹
          startCropSelection();
        } else {
          // ç¬¬äºŒæ¬¡æŒ‰F - è®¾ç½®ç»“æŸç‚¹å¹¶å®Œæˆé€‰æ‹©
          endCropSelection();
        }
      } else {
        console.log('è§†é¢‘è¿˜æœªåŠ è½½å®Œæˆ');
      }
      e.preventDefault();
      return;
    }
  });
  
  document.addEventListener('keyup', (e) => {
    // å¤„ç†Fé”®æ¾å¼€ - é‡ç½®æŒ‰é”®çŠ¶æ€
    if ((e.key === 'f' || e.key === 'F') && isPressingF) {
      console.log('Fé”®æ¾å¼€');
      isPressingF = false;
      e.preventDefault();
    }
  });

  // è‰²é”®åŠŸèƒ½äº‹ä»¶å¤„ç†
  enableChromaKey.onchange = () => {
    chromaKeyOptions.style.display = enableChromaKey.checked ? 'block' : 'none';
    updateColorPreview();
  };

  // é”®ç›˜è£å‰ªè¾…åŠ©å‡½æ•°
  function startKeyboardCrop() {
    console.log('startKeyboardCrop è¢«è°ƒç”¨');
    cropModeActive = true;
    
    // åˆå§‹åŒ–è£å‰ªåŒºåŸŸåˆ°è§†é¢‘ä¸­å¿ƒ
    currentCropRect = {
      x: Math.round((video.videoWidth - 200) / 2),
      y: Math.round((video.videoHeight - 150) / 2),
      width: 200,
      height: 150
    };
    
    console.log('åˆå§‹åŒ–è£å‰ªåŒºåŸŸ:', currentCropRect);
    
    // ç¡®ä¿ä¸è¶…å‡ºè¾¹ç•Œ
    currentCropRect.x = Math.max(0, Math.min(currentCropRect.x, video.videoWidth - currentCropRect.width));
    currentCropRect.y = Math.max(0, Math.min(currentCropRect.y, video.videoHeight - currentCropRect.height));
    
    console.log('è¾¹ç•Œæ£€æŸ¥å:', currentCropRect);
    
    createCropSelection();
    updateCropDisplay();
    
    // æ˜¾ç¤ºæ“ä½œæç¤º
    cropInfo.textContent = 'é”®ç›˜è£å‰ªæ¨¡å¼ï¼šä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨ï¼ŒShift+æ–¹å‘é”®è°ƒæ•´å¤§å°ï¼ŒEnterç¡®è®¤ï¼ŒEscå–æ¶ˆ';
    cropInfo.style.color = '#007cba';
    cropInfo.style.fontWeight = 'bold';
  }
  
  function updateCropDisplay() {
    console.log('updateCropDisplay è¢«è°ƒç”¨, cropSelection:', cropSelection);
    if (!cropSelection) return;
    
    // è®¡ç®—åœ¨æ˜¾ç¤ºåŒºåŸŸçš„ä½ç½®å’Œå¤§å°
    const videoRect = video.getBoundingClientRect();
    const scaleX = videoRect.width / video.videoWidth;
    const scaleY = videoRect.height / video.videoHeight;
    
    console.log('è§†é¢‘å°ºå¯¸:', {videoWidth: video.videoWidth, videoHeight: video.videoHeight});
    console.log('æ˜¾ç¤ºå°ºå¯¸:', {width: videoRect.width, height: videoRect.height});
    console.log('ç¼©æ”¾æ¯”ä¾‹:', {scaleX, scaleY});
    console.log('è£å‰ªåŒºåŸŸ:', currentCropRect);
    
    const displayLeft = currentCropRect.x * scaleX;
    const displayTop = currentCropRect.y * scaleY;
    const displayWidth = currentCropRect.width * scaleX;
    const displayHeight = currentCropRect.height * scaleY;
    
    console.log('æ˜¾ç¤ºä½ç½®:', {displayLeft, displayTop, displayWidth, displayHeight});
    
    cropSelection.style.left = displayLeft + 'px';
    cropSelection.style.top = displayTop + 'px';
    cropSelection.style.width = displayWidth + 'px';
    cropSelection.style.height = displayHeight + 'px';
  }
  
  function createCropSelection() {
    console.log('createCropSelection è¢«è°ƒç”¨');
    clearCropSelection();
    cropSelection = document.createElement('div');
    cropSelection.className = 'crop-selection';
    cropSelection.style.border = '2px solid #007cba';
    cropSelection.style.background = 'rgba(0, 124, 186, 0.1)';
    cropSelection.style.position = 'absolute';
    cropSelection.style.pointerEvents = 'none';
    
    console.log('cropOverlay:', cropOverlay);
    if (cropOverlay) {
      cropOverlay.appendChild(cropSelection);
      console.log('cropSelection å·²æ·»åŠ åˆ° cropOverlay');
    } else {
      console.error('cropOverlay ä¸å­˜åœ¨!');
    }
  }
  
  function confirmKeyboardCrop() {
    cropArea = { ...currentCropRect };
    cropModeActive = false;
    
    cropInfo.textContent = `${cropArea.width}x${cropArea.height} (èµ·ç‚¹: ${cropArea.x},${cropArea.y})`;
    cropInfo.style.color = '#28a745';
    cropInfo.style.fontWeight = 'normal';
    
    // ä¿æŒé€‰æ‹©æ¡†ä½†æ”¹ä¸ºç»¿è‰²è¡¨ç¤ºç¡®è®¤
    if (cropSelection) {
      cropSelection.style.border = '2px solid #28a745';
      cropSelection.style.background = 'rgba(40, 167, 69, 0.1)';
    }
  }
  
  function cancelKeyboardCrop() {
    cropModeActive = false;
    clearCropSelection();
    
    cropInfo.textContent = 'æœªè®¾ç½®';
    cropInfo.style.color = '';
    cropInfo.style.fontWeight = 'normal';
  }

  chromaKeyColor.onchange = updateColorPreview;
  
  chromaKeyTolerance.oninput = () => {
    toleranceValue.textContent = chromaKeyTolerance.value;
  };
  
  chromaKeySoftness.oninput = () => {
    softnessValue.textContent = chromaKeySoftness.value;
  };

  // é¢œè‰²é¢„è®¾æŒ‰é’®
  colorPresets.forEach(btn => {
    btn.onclick = () => {
      chromaKeyColor.value = btn.dataset.color;
      updateColorPreview();
      enableChromaKey.checked = true;
      chromaKeyOptions.style.display = 'block';
    };
  });

  // ä»è§†é¢‘æ‹¾è‰²
  pickColorBtn.onclick = () => {
    if (video.videoWidth === 0) {
      alert('è¯·å…ˆåŠ è½½è§†é¢‘ï¼');
      return;
    }
    isPickingColor = true;
    pickColorBtn.textContent = 'ğŸ¯ ç‚¹å‡»è§†é¢‘é€‰æ‹©é¢œè‰²';
    pickColorBtn.style.background = '#ff4500';
    status.textContent = 'ç‚¹å‡»è§†é¢‘ç”»é¢é€‰æ‹©è¦é€æ˜çš„é¢œè‰²';
    video.style.cursor = 'crosshair';
  };

  // è§†é¢‘ç‚¹å‡»æ‹¾è‰²
  video.onclick = (e) => {
    if (!isPickingColor) return;
    
    // åˆ›å»ºä¸´æ—¶canvasè·å–ç‚¹å‡»ä½ç½®çš„é¢œè‰²
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = video.videoWidth;
    tempCanvas.height = video.videoHeight;
    tempCtx.drawImage(video, 0, 0);
    
    const rect = video.getBoundingClientRect();
    const scaleX = video.videoWidth / rect.width;
    const scaleY = video.videoHeight / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;
    
    const pixel = tempCtx.getImageData(x, y, 1, 1).data;
    const hexColor = `#${pixel[0].toString(16).padStart(2, '0')}${pixel[1].toString(16).padStart(2, '0')}${pixel[2].toString(16).padStart(2, '0')}`;
    
    chromaKeyColor.value = hexColor;
    updateColorPreview();
    enableChromaKey.checked = true;
    chromaKeyOptions.style.display = 'block';
    
    // é€€å‡ºæ‹¾è‰²æ¨¡å¼
    isPickingColor = false;
    pickColorBtn.textContent = 'ğŸ¯ ä»è§†é¢‘é€‰å–';
    pickColorBtn.style.background = '#ff6b35';
    video.style.cursor = 'default';
    status.textContent = `å·²é€‰æ‹©é¢œè‰²: ${hexColor}`;
  };

  // æ›´æ–°é¢œè‰²é¢„è§ˆ
  function updateColorPreview() {
    const color = chromaKeyColor.value;
    colorPreview.style.setProperty('--preview-color', color);
    colorPreview.style.background = color;
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  updateColorPreview();

  video.onloadedmetadata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // âœ… ç¡®ä¿Canvasæ”¯æŒé€æ˜
    ctx.globalCompositeOperation = 'source-over';
    
    const fileName = videoUpload.files[0]?.name || '';
    const fileExtension = fileName.split('.').pop()?.toLowerCase();
    
    frameInfo.textContent = `è§†é¢‘å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}, æ—¶é•¿: ${video.duration.toFixed(2)}s`;
    
    if (fileExtension === 'mov') {
      status.textContent = "MOVè§†é¢‘å·²åŠ è½½å®Œæˆï¼Œæ”¯æŒé€æ˜é€šé“æå–ï¼ç‚¹å‡»å¼€å§‹æå–";
    } else {
      status.textContent = "è§†é¢‘å·²åŠ è½½ï¼Œç‚¹å‡»å¼€å§‹æå–";
    }
    
    startBtn.disabled = false; // å¯ç”¨å¼€å§‹æŒ‰é’®
    cropBtn.disabled = false; // å¯ç”¨è£å‰ªæŒ‰é’®
  };

  // æ·»åŠ è§†é¢‘åŠ è½½é”™è¯¯å¤„ç†
  video.onerror = (e) => {
    console.error('è§†é¢‘åŠ è½½é”™è¯¯:', e);
    const fileName = videoUpload.files[0]?.name || '';
    const fileExtension = fileName.split('.').pop()?.toLowerCase();
    
    if (fileExtension === 'mov') {
      status.textContent = "MOVæ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç¼–ç é—®é¢˜ã€‚å»ºè®®ä½¿ç”¨H.264ç¼–ç çš„MOVæ–‡ä»¶";
      alert('MOVæ–‡ä»¶åŠ è½½å¤±è´¥ï¼\n\nå¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š\n1. ç¡®ä¿MOVæ–‡ä»¶ä½¿ç”¨H.264ç¼–ç \n2. å°è¯•å°†MOVè½¬æ¢ä¸ºMP4æ ¼å¼\n3. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå');
    } else {
      status.textContent = "è§†é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼";
      alert('è§†é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å®Œæ•´æˆ–å°è¯•å…¶ä»–æ ¼å¼');
    }
    
    startBtn.disabled = true;
  };

  // ğŸ¨ è‰²é”®å¤„ç†å‡½æ•°
  function applyChromaKey(imageData) {
    const targetColor = hexToRgb(chromaKeyColor.value);
    const tolerance = parseInt(chromaKeyTolerance.value);
    const softness = parseInt(chromaKeySoftness.value);
    
    const data = imageData.data;
    
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];
      
      // è®¡ç®—é¢œè‰²è·ç¦»
      const distance = Math.sqrt(
        Math.pow(r - targetColor.r, 2) + 
        Math.pow(g - targetColor.g, 2) + 
        Math.pow(b - targetColor.b, 2)
      );
      
      // å½’ä¸€åŒ–è·ç¦» (0-441 -> 0-100)
      const normalizedDistance = (distance / 441) * 100;
      
      if (normalizedDistance <= tolerance) {
        // åœ¨å®¹å·®èŒƒå›´å†…ï¼Œåº”ç”¨é€æ˜åº¦
        if (normalizedDistance <= tolerance - softness) {
          // å®Œå…¨é€æ˜
          data[i + 3] = 0;
        } else {
          // æ¸å˜é€æ˜ï¼ˆç¾½åŒ–æ•ˆæœï¼‰
          const alpha = ((normalizedDistance - (tolerance - softness)) / softness);
          data[i + 3] = Math.round(alpha * 255);
        }
        
        // é€æ˜åƒç´ çš„RGBè®¾ä¸º0
        if (data[i + 3] === 0) {
          data[i] = 0;
          data[i + 1] = 0;
          data[i + 2] = 0;
        }
      }
    }
  }

  // è¾…åŠ©å‡½æ•°ï¼šåå…­è¿›åˆ¶è½¬RGB
  function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  // æå–å•å¸§çš„alphaå›¾
  function extractFrame(frameNumber) {
    return new Promise((resolve) => {
      // è®¾ç½®ç”»å¸ƒå°ºå¯¸
      let targetWidth = video.videoWidth;
      let targetHeight = video.videoHeight;
      
      // å¦‚æœæœ‰è£å‰ªåŒºåŸŸï¼Œä½¿ç”¨è£å‰ªå°ºå¯¸
      if (cropArea) {
        targetWidth = cropArea.width;
        targetHeight = cropArea.height;
        canvas.width = targetWidth;
        canvas.height = targetHeight;
      } else {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }
      
      // âœ… æ¸…é™¤ä¸ºé€æ˜èƒŒæ™¯
      ctx.save();
      ctx.globalCompositeOperation = 'copy';
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.restore();
      
      // ç»˜åˆ¶è§†é¢‘å¸§ï¼ˆæ”¯æŒè£å‰ªï¼‰
      if (cropArea) {
        // è£å‰ªæ¨¡å¼ï¼šåªç»˜åˆ¶æŒ‡å®šåŒºåŸŸ
        ctx.drawImage(
          video, 
          cropArea.x, cropArea.y, cropArea.width, cropArea.height, // æºåŒºåŸŸ
          0, 0, targetWidth, targetHeight // ç›®æ ‡åŒºåŸŸ
        );
      } else {
        // å®Œæ•´æ¨¡å¼ï¼šç»˜åˆ¶æ•´ä¸ªè§†é¢‘
        ctx.drawImage(video, 0, 0);
      }
      
      // è·å–å›¾åƒæ•°æ®
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      
      // ğŸ¨ è‰²é”®å¤„ç†
      if (enableChromaKey.checked) {
        applyChromaKey(imageData);
      }
      
      // ğŸ”§ å¤„ç†Alphaé€šé“ï¼ˆç¡®ä¿é€æ˜åº¦æ­£ç¡®ï¼‰
      let hasRealAlpha = false;
      for (let i = 0; i < imageData.data.length; i += 4) {
          const alpha = imageData.data[i + 3];
          if (alpha > 0 && alpha < 255) {
              hasRealAlpha = true;
          }
          
          // å¤„ç†é¢„ä¹˜Alphaæˆ–é”™è¯¯çš„Alphaå€¼
          if (alpha === 0) {
              // ç¡®ä¿å®Œå…¨é€æ˜çš„åƒç´ RGBä¹Ÿæ˜¯0
              imageData.data[i] = 0;     // R
              imageData.data[i + 1] = 0; // G  
              imageData.data[i + 2] = 0; // B
          }
      }
      
      if (frameNumber === 25) {
          console.log(`å¸§ ${frameNumber}: çœŸå®Alphaé€šé“${hasRealAlpha ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
          if (enableChromaKey.checked) {
              console.log(`å¸§ ${frameNumber}: åº”ç”¨äº†è‰²é”®å¤„ç†`);
          }
      }
      
      // å°†å¤„ç†åçš„æ•°æ®å†™å›Canvas
      ctx.putImageData(imageData, 0, 0);
      
      // ğŸ¯ å¼ºåˆ¶PNGæ ¼å¼å¹¶ç¡®ä¿è´¨é‡ - å­˜å‚¨åˆ°æ•°ç»„è€Œä¸æ˜¯ä¸‹è½½
      canvas.toBlob((blob) => {
          if (!blob) {
              console.error('PNGç”Ÿæˆå¤±è´¥');
              resolve();
              return;
          }
          
          console.log(`å¸§ ${frameNumber}: PNGå¤§å° ${blob.size} bytes`);
          
          // å­˜å‚¨å¸§æ•°æ®åˆ°æ•°ç»„
          const fileName = `frame_${frameNumber.toString().padStart(4, '0')}_alpha.png`;
          extractedFrames.push({
              blob: blob,
              filename: fileName
          });
          
          resolve();
      }, 'image/png', 1.0); // ç¡®ä¿æœ€é«˜è´¨é‡
    });
  }

  // é€å¸§æå–å‡½æ•°
  async function extractFrames() {
    if (!isExtracting) return;

    const currentTime = frameCount / fps;

    if (currentTime >= video.duration) {
      // æå–å®Œæˆ
      isExtracting = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      downloadBtn.disabled = false;
      status.textContent = `æå–å®Œæˆï¼å…±æå– ${frameCount} å¸§ï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®è·å–æ‰€æœ‰å¸§`;
      return;
    }

    // è®¾ç½®è§†é¢‘æ—¶é—´
    video.currentTime = currentTime;

    // ç­‰å¾…è§†é¢‘seekå®Œæˆ
    video.onseeked = async () => {
      await extractFrame(frameCount);
      frameCount++;

      status.textContent = `æ­£åœ¨æå–ç¬¬ ${frameCount} å¸§...`;
      frameInfo.textContent = `å¸§æ•°: ${frameCount} / æ—¶é—´: ${currentTime.toFixed(2)}s`;

      // å»¶è¿Ÿä¸€ç‚¹å†å¤„ç†ä¸‹ä¸€å¸§ï¼Œé¿å…è¿‡å¿«
      setTimeout(extractFrames, 100);
    };
  }

  // å¼€å§‹æå–
  startBtn.onclick = () => {
    if (video.readyState < 2) {
      status.textContent = "è§†é¢‘è¿˜æœªåŠ è½½å®Œæˆ";
      return;
    }

    isExtracting = true;
    frameCount = 0;
    extractedFrames = []; // æ¸…ç©ºä¹‹å‰çš„å¸§æ•°æ®
    startBtn.disabled = true;
    stopBtn.disabled = false;
    downloadBtn.disabled = true;
    status.textContent = "å¼€å§‹æå–å¸§...";

    video.pause(); // ç¡®ä¿è§†é¢‘æš‚åœ
    extractFrames();
  };

  // åœæ­¢æå–
  stopBtn.onclick = () => {
    isExtracting = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    if (extractedFrames.length > 0) {
      downloadBtn.disabled = false;
    }
    status.textContent = `æå–å·²åœæ­¢ï¼Œå·²æå– ${frameCount} å¸§`;
  };

  // ä¸‹è½½æ‰€æœ‰æå–çš„å¸§
  downloadBtn.onclick = async () => {
    if (extractedFrames.length === 0) {
      alert('æ²¡æœ‰å¯ä¸‹è½½çš„å¸§');
      return;
    }

    status.textContent = 'æ­£åœ¨æ‰“åŒ…ä¸‹è½½...';
    downloadBtn.disabled = true;

    try {
      // ä½¿ç”¨JSZipåº“æ‰“åŒ…æ–‡ä»¶
      const zip = new JSZip();
      
      // æ·»åŠ æ‰€æœ‰å¸§åˆ°ZIPæ–‡ä»¶
      for (let i = 0; i < extractedFrames.length; i++) {
        const frame = extractedFrames[i];
        zip.file(frame.filename, frame.blob);
      }

      // ç”ŸæˆZIPæ–‡ä»¶
      const zipBlob = await zip.generateAsync({type: "blob"});
      
      // ä¸‹è½½ZIPæ–‡ä»¶
      const link = document.createElement('a');
      link.href = URL.createObjectURL(zipBlob);
      link.download = `extracted_frames_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.zip`;
      link.click();
      
      setTimeout(() => URL.revokeObjectURL(link.href), 1000);
      
      status.textContent = `ä¸‹è½½å®Œæˆï¼å…± ${extractedFrames.length} å¸§å·²æ‰“åŒ…ä¸‹è½½`;
    } catch (error) {
      console.error('æ‰“åŒ…ä¸‹è½½å¤±è´¥:', error);
      status.textContent = 'æ‰“åŒ…ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
    } finally {
      downloadBtn.disabled = false;
    }
  };

  // æµ‹è¯•è§†é¢‘ç”ŸæˆåŠŸèƒ½
  const generateTestBtn = document.getElementById('generateTestBtn');
  const generateStatus = document.getElementById('generateStatus');

  generateTestBtn.onclick = async () => {
    const bgColor = document.getElementById('testBgColor').value;
    const animation = document.getElementById('testAnimation').value;
    const duration = parseInt(document.getElementById('testDuration').value) * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
    const format = document.getElementById('testFormat').value;

    generateTestBtn.disabled = true;
    generateStatus.textContent = `æ­£åœ¨ç”Ÿæˆ${format.toUpperCase()}æµ‹è¯•è§†é¢‘...`;

    try {
      // åˆ›å»ºç”¨äºå½•åˆ¶çš„Canvas
      const recordCanvas = document.createElement('canvas');
      const recordCtx = recordCanvas.getContext('2d');
      recordCanvas.width = 800;
      recordCanvas.height = 600;

      // è®¾ç½®å½•åˆ¶å‚æ•° - æ ¹æ®é€‰æ‹©çš„æ ¼å¼
      const stream = recordCanvas.captureStream(30); // 30 FPS
      
      let mimeType, fileExtension;
      
      if (format === 'mp4') {
        // å°è¯•MP4æ ¼å¼
        if (MediaRecorder.isTypeSupported('video/mp4; codecs=avc1.42E01E')) {
          mimeType = 'video/mp4; codecs=avc1.42E01E';
        } else if (MediaRecorder.isTypeSupported('video/mp4')) {
          mimeType = 'video/mp4';
        } else {
          // é™çº§åˆ°WebM
          mimeType = 'video/webm; codecs=vp9';
          fileExtension = 'webm';
          generateStatus.textContent = 'æµè§ˆå™¨ä¸æ”¯æŒMP4ï¼Œå°†ç”ŸæˆWebMæ ¼å¼...';
        }
        fileExtension = fileExtension || 'mp4';
      } else {
        // WebMæ ¼å¼
        mimeType = 'video/webm; codecs=vp9';
        fileExtension = 'webm';
      }
      
      const recorder = new MediaRecorder(stream, { mimeType });

      const chunks = [];
      recorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          chunks.push(event.data);
        }
      };

      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: mimeType });
        
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `test_video_${animation}_${Date.now()}.${fileExtension}`;
        link.click();
        
        setTimeout(() => URL.revokeObjectURL(link.href), 1000);
        
        generateStatus.textContent = `âœ“ ${fileExtension.toUpperCase()}æµ‹è¯•è§†é¢‘ç”Ÿæˆå®Œæˆï¼`;
        generateTestBtn.disabled = false;
      };

      // å¼€å§‹å½•åˆ¶
      recorder.start();

      // åŠ¨ç”»å¾ªç¯
      let startTime = Date.now();
      const animate = () => {
        const elapsed = Date.now() - startTime;
        const progress = elapsed / duration;

        // æ¸…é™¤ç”»å¸ƒå¹¶å¡«å……èƒŒæ™¯è‰²
        recordCtx.fillStyle = bgColor;
        recordCtx.fillRect(0, 0, recordCanvas.width, recordCanvas.height);

        // ç»˜åˆ¶åŠ¨ç”»å¯¹è±¡
        switch (animation) {
          case 'circle':
            // ç§»åŠ¨çš„åœ†åœˆ
            const x = 100 + (recordCanvas.width - 200) * Math.sin(progress * Math.PI * 4);
            const y = recordCanvas.height / 2 + 100 * Math.sin(progress * Math.PI * 8);
            recordCtx.fillStyle = '#ff0000';
            recordCtx.beginPath();
            recordCtx.arc(x, y, 50, 0, Math.PI * 2);
            recordCtx.fill();
            break;

          case 'square':
            // æ—‹è½¬çš„æ–¹å—
            const centerX = recordCanvas.width / 2;
            const centerY = recordCanvas.height / 2;
            const rotation = progress * Math.PI * 4;
            
            recordCtx.save();
            recordCtx.translate(centerX, centerY);
            recordCtx.rotate(rotation);
            recordCtx.fillStyle = '#0000ff';
            recordCtx.fillRect(-50, -50, 100, 100);
            recordCtx.restore();
            break;

          case 'text':
            // æ»šåŠ¨æ–‡å­—
            const textX = recordCanvas.width - (progress * (recordCanvas.width + 400));
            recordCtx.fillStyle = '#800080';
            recordCtx.font = 'bold 60px Arial';
            recordCtx.fillText('æµ‹è¯•è§†é¢‘ TEST VIDEO', textX, recordCanvas.height / 2);
            break;
        }

        // æ·»åŠ æ—¶é—´æˆ³
        recordCtx.fillStyle = '#000000';
        recordCtx.font = '16px Arial';
        recordCtx.fillText(`æ—¶é—´: ${(elapsed / 1000).toFixed(1)}s`, 10, 30);

        if (elapsed < duration) {
          requestAnimationFrame(animate);
        } else {
          // å½•åˆ¶å®Œæˆ
          recorder.stop();
        }
      };

      // å¼€å§‹åŠ¨ç”»
      animate();

    } catch (error) {
      console.error('ç”Ÿæˆæµ‹è¯•è§†é¢‘å¤±è´¥:', error);
      generateStatus.textContent = 'âŒ ç”Ÿæˆå¤±è´¥ï¼Œæµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒè§†é¢‘å½•åˆ¶';
      generateTestBtn.disabled = false;
    }
  };

  // ========== è£å‰ªåŠŸèƒ½ ==========
  
  // è£å‰ªæŒ‰é’®ç‚¹å‡»äº‹ä»¶
  cropBtn.onclick = () => {
    if (cropSection.style.display === 'none' || !cropSection.style.display) {
      cropSection.style.display = 'block';
      cropBtn.textContent = 'âœ‚ï¸ å…³é—­è£å‰ªè®¾ç½®';
    } else {
      cropSection.style.display = 'none';
      cropBtn.textContent = 'âœ‚ï¸ è®¾ç½®è£å‰ªåŒºåŸŸ';
    }
  };

  // è£å‰ªæ¨¡å¼åˆ‡æ¢
  cropMode.onchange = () => {
    currentCropMode = cropMode.value;
    
    // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
    clearCropSelection();
    
    // æ˜¾ç¤º/éšè—ç›¸åº”çš„è®¾ç½®é¢æ¿
    if (currentCropMode === 'manual') {
      manualCrop.style.display = 'block';
      centerCrop.style.display = 'none';
      enableManualCrop();
    } else if (currentCropMode === 'center') {
      manualCrop.style.display = 'none';
      centerCrop.style.display = 'block';
      disableManualCrop(); // æ¸…ç†æ‰‹åŠ¨è£å‰ªäº‹ä»¶
      // è®¾ç½®é»˜è®¤å°ºå¯¸
      cropWidth.value = Math.floor(video.videoWidth * 0.8);
      cropHeight.value = Math.floor(video.videoHeight * 0.8);
    } else {
      manualCrop.style.display = 'none';
      centerCrop.style.display = 'none';
      disableManualCrop(); // æ¸…ç†æ‰‹åŠ¨è£å‰ªäº‹ä»¶
      cropArea = null;
      updateCropInfo();
    }
  };

  // ç¦ç”¨æ‰‹åŠ¨è£å‰ªåŠŸèƒ½
  function disableManualCrop() {
    video.style.cursor = 'default';
    video.onmousedown = null;
    video.onmousemove = null;
    video.onmouseup = null;
    
    // é‡ç½®é”®ç›˜è£å‰ªçŠ¶æ€
    cropModeActive = false;
    clearCropSelection();
  }

  // å¯ç”¨æ‰‹åŠ¨è£å‰ªåŠŸèƒ½ï¼ˆç°åœ¨ä½¿ç”¨Fé”®é€‰æ‹©åŒºåŸŸï¼‰
  function enableManualCrop() {
    // è®¾ç½®è§†é¢‘é»˜è®¤æ ·å¼
    video.style.cursor = 'crosshair';
    
    // æ¸…é™¤ä¹‹å‰çš„é¼ æ ‡äº‹ä»¶
    video.onmousedown = null;
    video.onmousemove = null;
    video.onmouseup = null;
    
    // é‡ç½®è£å‰ªçŠ¶æ€
    cropModeActive = false;
    isPressingF = false;
    clearCropSelection();
    
    // æ˜¾ç¤ºæ“ä½œæç¤º
    cropInfo.textContent = 'æŒ‰Fé”®å¼€å§‹é€‰æ‹©ï¼Œå†æŒ‰Fé”®ç»“æŸé€‰æ‹©';
    cropInfo.style.color = '#666';
    cropInfo.style.fontWeight = 'normal';
  }


  // åº”ç”¨å±…ä¸­è£å‰ª
  applyCenterCrop.onclick = () => {
    const width = parseInt(cropWidth.value);
    const height = parseInt(cropHeight.value);
    
    if (!width || !height || width < 50 || height < 50) {
      alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è£å‰ªå°ºå¯¸ï¼ˆæœ€å°50x50ï¼‰');
      return;
    }
    
    if (width > video.videoWidth || height > video.videoHeight) {
      alert('è£å‰ªå°ºå¯¸ä¸èƒ½è¶…è¿‡è§†é¢‘åŸå§‹å°ºå¯¸');
      return;
    }
    
    cropArea = {
      x: Math.floor((video.videoWidth - width) / 2),
      y: Math.floor((video.videoHeight - height) / 2),
      width: width,
      height: height
    };
    
    updateCropInfo();
    showCenterCropPreview();
  };

  // æ˜¾ç¤ºå±…ä¸­è£å‰ªé¢„è§ˆ
  function showCenterCropPreview() {
    clearCropSelection();
    
    if (cropArea) {
      const videoRect = video.getBoundingClientRect();
      const scaleX = videoRect.width / video.videoWidth;
      const scaleY = videoRect.height / video.videoHeight;
      
      cropSelection = document.createElement('div');
      cropSelection.className = 'crop-selection';
      cropSelection.style.left = (cropArea.x * scaleX) + 'px';
      cropSelection.style.top = (cropArea.y * scaleY) + 'px';
      cropSelection.style.width = (cropArea.width * scaleX) + 'px';
      cropSelection.style.height = (cropArea.height * scaleY) + 'px';
      cropOverlay.appendChild(cropSelection);
    }
  }

  // é‡ç½®è£å‰ªé€‰æ‹©
  resetCrop.onclick = () => {
    cropModeActive = false;
    clearCropSelection();
    cropArea = null;
    updateCropInfo();
    
    // é‡ç½®æç¤ºæ–‡å­—
    cropInfo.textContent = 'æŒ‰Fé”®å¼€å§‹è£å‰ªï¼Œç„¶åä½¿ç”¨æ–¹å‘é”®è°ƒæ•´';
    cropInfo.style.color = '#666';
    cropInfo.style.fontWeight = 'normal';
  };

  // å¼€å§‹è£å‰ªé€‰æ‹©ï¼ˆç¬¬ä¸€æ¬¡æŒ‰Fé”®ï¼‰
  function startCropSelection() {
    console.log('å¼€å§‹è£å‰ªé€‰æ‹©');
    cropModeActive = true;
    
    // è·å–å½“å‰é¼ æ ‡ä½ç½®ç›¸å¯¹äºè§†é¢‘çš„åæ ‡
    const videoRect = video.getBoundingClientRect();
    const scaleX = video.videoWidth / videoRect.width;
    const scaleY = video.videoHeight / videoRect.height;
    
    // è®¡ç®—åœ¨è§†é¢‘åæ ‡ç³»ä¸­çš„ä½ç½®
    cropStartPos.x = (lastMousePos.x - videoRect.left) * scaleX;
    cropStartPos.y = (lastMousePos.y - videoRect.top) * scaleY;
    
    // ç¡®ä¿èµ·å§‹ä½ç½®åœ¨è§†é¢‘èŒƒå›´å†…
    cropStartPos.x = Math.max(0, Math.min(cropStartPos.x, video.videoWidth));
    cropStartPos.y = Math.max(0, Math.min(cropStartPos.y, video.videoHeight));
    
    console.log('è£å‰ªèµ·å§‹ç‚¹:', cropStartPos);
    
    // æ˜¾ç¤ºèµ·å§‹ç‚¹æ ‡è®°
    clearCropSelection();
    createStartMarker();
    
    cropInfo.textContent = `èµ·å§‹ç‚¹: (${cropStartPos.x.toFixed(0)}, ${cropStartPos.y.toFixed(0)}) - å†æŒ‰Fé”®é€‰æ‹©ç»“æŸç‚¹`;
    cropInfo.style.color = '#007bff';
    cropInfo.style.fontWeight = 'bold';
  }
  
  // ç»“æŸè£å‰ªé€‰æ‹©ï¼ˆç¬¬äºŒæ¬¡æŒ‰Fé”®ï¼‰
  function endCropSelection() {
    console.log('ç»“æŸè£å‰ªé€‰æ‹©');
    
    // è·å–å½“å‰é¼ æ ‡ä½ç½®ç›¸å¯¹äºè§†é¢‘çš„åæ ‡
    const videoRect = video.getBoundingClientRect();
    const scaleX = video.videoWidth / videoRect.width;
    const scaleY = video.videoHeight / videoRect.height;
    
    // è®¡ç®—ç»“æŸä½ç½®
    const endX = (lastMousePos.x - videoRect.left) * scaleX;
    const endY = (lastMousePos.y - videoRect.top) * scaleY;
    
    // ç¡®ä¿ç»“æŸä½ç½®åœ¨è§†é¢‘èŒƒå›´å†…
    const clampedEndX = Math.max(0, Math.min(endX, video.videoWidth));
    const clampedEndY = Math.max(0, Math.min(endY, video.videoHeight));
    
    console.log('è£å‰ªç»“æŸç‚¹:', { x: clampedEndX, y: clampedEndY });
    
    // è®¡ç®—è£å‰ªåŒºåŸŸ
    const left = Math.min(cropStartPos.x, clampedEndX);
    const top = Math.min(cropStartPos.y, clampedEndY);
    const right = Math.max(cropStartPos.x, clampedEndX);
    const bottom = Math.max(cropStartPos.y, clampedEndY);
    
    currentCropRect = {
      x: left,
      y: top,
      width: right - left,
      height: bottom - top
    };
    
    // æ£€æŸ¥é€‰æ‹©åŒºåŸŸæ˜¯å¦æœ‰æ•ˆ
    if (currentCropRect.width > 20 && currentCropRect.height > 20) {
      confirmCropSelection();
    } else {
      cancelCropSelection();
    }
  }
  
  // åˆ›å»ºèµ·å§‹ç‚¹æ ‡è®°
  function createStartMarker() {
    const marker = document.createElement('div');
    marker.id = 'crop-start-marker';
    marker.style.position = 'absolute';
    marker.style.width = '10px';
    marker.style.height = '10px';
    marker.style.backgroundColor = '#007bff';
    marker.style.border = '2px solid white';
    marker.style.borderRadius = '50%';
    marker.style.pointerEvents = 'none';
    marker.style.zIndex = '1001';
    marker.style.transform = 'translate(-50%, -50%)';
    
    // è®¡ç®—æ˜¾ç¤ºä½ç½®
    const videoRect = video.getBoundingClientRect();
    const scaleX = videoRect.width / video.videoWidth;
    const scaleY = videoRect.height / video.videoHeight;
    
    const displayX = cropStartPos.x * scaleX;
    const displayY = cropStartPos.y * scaleY;
    
    marker.style.left = displayX + 'px';
    marker.style.top = displayY + 'px';
    
    // æ·»åŠ åˆ°è§†é¢‘å®¹å™¨
    const videoContainer = video.parentElement;
    if (!videoContainer.style.position || videoContainer.style.position === 'static') {
      videoContainer.style.position = 'relative';
    }
    videoContainer.appendChild(marker);
    
    cropSelection = marker; // é‡ç”¨cropSelectionå˜é‡
  }
  
  // ç¡®è®¤è£å‰ªé€‰æ‹©
  function confirmCropSelection() {
    cropArea = { ...currentCropRect };
    cropModeActive = false;
    
    cropInfo.textContent = `è£å‰ªåŒºåŸŸ: ${cropArea.width.toFixed(0)}x${cropArea.height.toFixed(0)} (èµ·ç‚¹: ${cropArea.x.toFixed(0)},${cropArea.y.toFixed(0)})`;
    cropInfo.style.color = '#28a745';
    cropInfo.style.fontWeight = 'bold';
    
    // æ¸…é™¤èµ·å§‹ç‚¹æ ‡è®°ï¼Œåˆ›å»ºå®Œæ•´é€‰æ‹©æ¡†
    clearCropSelection();
    createCropSelection();
    
    // è®¾ç½®ä¸ºç»¿è‰²è¡¨ç¤ºç¡®è®¤
    if (cropSelection) {
      cropSelection.style.border = '2px solid #28a745';
      cropSelection.style.background = 'rgba(40, 167, 69, 0.1)';
    }
    
    console.log('è£å‰ªåŒºåŸŸå·²ç¡®è®¤:', cropArea);
  }
  
  // å–æ¶ˆè£å‰ªé€‰æ‹©
  function cancelCropSelection() {
    cropModeActive = false;
    clearCropSelection();
    
    cropInfo.textContent = 'é€‰æ‹©åŒºåŸŸå¤ªå°æˆ–æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©ï¼ˆæœ€å°20x20åƒç´ ï¼‰';
    cropInfo.style.color = '#dc3545';
    cropInfo.style.fontWeight = 'normal';
    
    console.log('è£å‰ªé€‰æ‹©å–æ¶ˆ');
  }

  
  // åˆ›å»ºè£å‰ªé€‰æ‹©æ¡†
  function createCropSelection() {
    if (cropSelection) {
      clearCropSelection();
    }
    
    cropSelection = document.createElement('div');
    cropSelection.id = 'crop-selection';
    cropSelection.style.position = 'absolute';
    cropSelection.style.border = '2px dashed #007bff';
    cropSelection.style.background = 'rgba(0, 123, 255, 0.1)';
    cropSelection.style.pointerEvents = 'none';
    cropSelection.style.zIndex = '1000';
    
    // è®¡ç®—æ˜¾ç¤ºåæ ‡å’Œå°ºå¯¸
    const videoRect = video.getBoundingClientRect();
    const scaleX = videoRect.width / video.videoWidth;
    const scaleY = videoRect.height / video.videoHeight;
    
    const displayLeft = currentCropRect.x * scaleX;
    const displayTop = currentCropRect.y * scaleY;
    const displayWidth = currentCropRect.width * scaleX;
    const displayHeight = currentCropRect.height * scaleY;
    
    cropSelection.style.left = displayLeft + 'px';
    cropSelection.style.top = displayTop + 'px';
    cropSelection.style.width = displayWidth + 'px';
    cropSelection.style.height = displayHeight + 'px';
    
    // æ·»åŠ åˆ°è§†é¢‘å®¹å™¨
    const videoContainer = video.parentElement;
    if (!videoContainer.style.position || videoContainer.style.position === 'static') {
      videoContainer.style.position = 'relative';
    }
    videoContainer.appendChild(cropSelection);
  }

  // æ¸…é™¤è£å‰ªé€‰æ‹©æ¡†
  function clearCropSelection() {
    if (cropSelection && cropSelection.parentNode) {
      cropSelection.parentNode.removeChild(cropSelection);
      cropSelection = null;
    }
    
    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„èµ·å§‹ç‚¹æ ‡è®°
    const existingMarker = document.getElementById('crop-start-marker');
    if (existingMarker && existingMarker.parentNode) {
      existingMarker.parentNode.removeChild(existingMarker);
    }
  }

  // æ›´æ–°è£å‰ªä¿¡æ¯æ˜¾ç¤º
  function updateCropInfo() {
    if (cropArea) {
      cropInfo.textContent = `${cropArea.width}x${cropArea.height} (èµ·ç‚¹: ${cropArea.x},${cropArea.y})`;
    } else {
      cropInfo.textContent = 'æœªè®¾ç½®';
    }
  }
</script>

<div id="usage-tips" style="margin-top: 30px; padding: 15px; background: #f9f9f9; border-radius: 5px; border-left: 4px solid #007cba;">
  <h4 style="margin-top: 0; color: #007cba;">ğŸ“‹ ä½¿ç”¨è¯´æ˜</h4>
  <ul style="margin: 0; padding-left: 20px; color: #555;">
    <li><strong>MOVæ ¼å¼æ”¯æŒï¼š</strong>å®Œå…¨æ”¯æŒApple ProRes 4444ã€Animationç¼–ç ç­‰å¸¦é€æ˜é€šé“çš„MOVæ–‡ä»¶</li>
    <li><strong>æœ€ä½³å®è·µï¼š</strong>ä½¿ç”¨H.264æˆ–H.265ç¼–ç çš„MOVæ–‡ä»¶å¯è·å¾—æœ€ä½³å…¼å®¹æ€§</li>
    <li><strong>é€æ˜é€šé“ï¼š</strong>å·¥å…·ä¼šè‡ªåŠ¨æ£€æµ‹å’Œä¿ç•™è§†é¢‘ä¸­çš„é€æ˜ä¿¡æ¯</li>
    <li><strong>ğŸ¨ è‰²é”®åŠŸèƒ½ï¼š</strong>å¯æŒ‡å®šç‰¹å®šé¢œè‰²ï¼ˆå¦‚ç»¿å¹•ã€è“å¹•ï¼‰ä½œä¸ºé€æ˜èƒŒæ™¯ï¼Œæ”¯æŒå®¹å·®å’Œç¾½åŒ–è°ƒèŠ‚</li>
    <li><strong>é¢œè‰²é€‰å–ï¼š</strong>æ”¯æŒæ‰‹åŠ¨é€‰æ‹©é¢œè‰²æˆ–ç›´æ¥ä»è§†é¢‘ç”»é¢ä¸­æ‹¾å–ç›®æ ‡é¢œè‰²</li>
    <li><strong>è¾“å‡ºæ ¼å¼ï¼š</strong>æ‰€æœ‰å¸§éƒ½ä¼šå¯¼å‡ºä¸ºPNGæ ¼å¼ä»¥ä¿æŒé€æ˜åº¦</li>
    <li><strong>æ‰¹é‡å¤„ç†ï¼š</strong>æå–å®Œæˆåå¯ä¸€æ¬¡æ€§ä¸‹è½½æ‰€æœ‰å¸§çš„ZIPå‹ç¼©åŒ…</li>
  </ul>
</div>

</body>
</html>