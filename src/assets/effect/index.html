<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§†é¢‘å¸§æå–å·¥å…·</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

<div id="upload-section">
  <h3>ä¸Šä¼ è§†é¢‘æ–‡ä»¶</h3>
  <input type="file" id="videoUpload" accept="video/*" />
  <button id="uploadBtn">ä¸Šä¼ è§†é¢‘</button>
</div>

<video id="vid" style="background: red;" crossorigin="anonymous" muted playsinline controls></video>
<canvas id="canvas"></canvas>

<div id="controls">
  <button id="startBtn" disabled>å¼€å§‹æå–å¸§</button>
  <button id="stopBtn" disabled>åœæ­¢æå–</button>
  <button id="downloadBtn" disabled>ä¸‹è½½æå–çš„å¸§</button>
  <span id="status">è¯·å…ˆä¸Šä¼ è§†é¢‘æ–‡ä»¶</span>
</div>
<div id="progress">
  <div id="frameInfo">å¸§æ•°: 0 / æ€»æ—¶é•¿: 0s</div>
</div>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
  }

  #upload-section {
    background: #f5f5f5;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
    border: 2px dashed #ccc;
  }

  #upload-section h3 {
    margin-top: 0;
    color: #333;
  }

  #videoUpload {
    margin-right: 10px;
    padding: 5px;
  }

  #controls {
    margin: 10px 0;
  }

  button {
    margin-right: 10px;
    padding: 8px 16px;
    background: #007cba;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  button:hover:not(:disabled) {
    background: #005a8b;
  }

  button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  #downloadBtn {
    background: #28a745;
  }

  #downloadBtn:hover:not(:disabled) {
    background: #218838;
  }

  #status {
    font-weight: bold;
    color: #333;
  }

  #progress {
    margin-top: 10px;
  }

  canvas {
    border: 1px solid #ccc;
    max-width: 100%;
  }

  video {
    max-width: 100%;
    margin: 10px 0;
  }
</style>

<script>
  const video = document.getElementById('vid');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha: true }); // âœ… å¯ç”¨Alpha
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const videoUpload = document.getElementById('videoUpload');
  const status = document.getElementById('status');
  const frameInfo = document.getElementById('frameInfo');
  
  let nowFrame = 0;
  let frameCount = 0;
  let isExtracting = false;
  let fps = 18; // é»˜è®¤FPSï¼Œä¼šåœ¨è§†é¢‘åŠ è½½åæ›´æ–°
  let extractedFrames = []; // å­˜å‚¨æå–çš„å¸§æ•°æ®

  // ä¸Šä¼ è§†é¢‘å¤„ç†
  uploadBtn.onclick = () => {
    const file = videoUpload.files[0];
    if (!file) {
      alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶');
      return;
    }

    if (!file.type.startsWith('video/')) {
      alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶');
      return;
    }

    const url = URL.createObjectURL(file);
    video.src = url;
    video.load();
    
    status.textContent = "æ­£åœ¨åŠ è½½è§†é¢‘...";
    extractedFrames = []; // æ¸…ç©ºä¹‹å‰çš„å¸§æ•°æ®
    downloadBtn.disabled = true;
  };

  // æ–‡ä»¶é€‰æ‹©å˜åŒ–å¤„ç†
  videoUpload.onchange = () => {
    uploadBtn.disabled = !videoUpload.files[0];
  };

  video.onloadedmetadata = () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // âœ… ç¡®ä¿Canvasæ”¯æŒé€æ˜
    ctx.globalCompositeOperation = 'source-over';
    
    frameInfo.textContent = `è§†é¢‘å°ºå¯¸: ${video.videoWidth}x${video.videoHeight}, æ—¶é•¿: ${video.duration.toFixed(2)}s`;
    status.textContent = "è§†é¢‘å·²åŠ è½½ï¼Œç‚¹å‡»å¼€å§‹æå–";
    startBtn.disabled = false; // å¯ç”¨å¼€å§‹æŒ‰é’®
  };

  // æå–å•å¸§çš„alphaå›¾
  function extractFrame(frameNumber) {
    return new Promise((resolve) => {
      // âœ… æ¸…é™¤ä¸ºé€æ˜èƒŒæ™¯
      ctx.save();
      ctx.globalCompositeOperation = 'copy';
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.restore();
      
      // ç»˜åˆ¶è§†é¢‘å¸§
      ctx.drawImage(video, 0, 0);
      
      // è·å–å›¾åƒæ•°æ®
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      
      // ğŸ”§ å¤„ç†Alphaé€šé“ï¼ˆç¡®ä¿é€æ˜åº¦æ­£ç¡®ï¼‰
      let hasRealAlpha = false;
      for (let i = 0; i < imageData.data.length; i += 4) {
          const alpha = imageData.data[i + 3];
          if (alpha > 0 && alpha < 255) {
              hasRealAlpha = true;
          }
          
          // å¤„ç†é¢„ä¹˜Alphaæˆ–é”™è¯¯çš„Alphaå€¼
          if (alpha === 0) {
              // ç¡®ä¿å®Œå…¨é€æ˜çš„åƒç´ RGBä¹Ÿæ˜¯0
              imageData.data[i] = 0;     // R
              imageData.data[i + 1] = 0; // G  
              imageData.data[i + 2] = 0; // B
          }
      }
      
      if (frameNumber === 25) {
          console.log(`å¸§ ${frameNumber}: çœŸå®Alphaé€šé“${hasRealAlpha ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
      }
      
      // å°†å¤„ç†åçš„æ•°æ®å†™å›Canvas
      ctx.putImageData(imageData, 0, 0);
      
      // ğŸ¯ å¼ºåˆ¶PNGæ ¼å¼å¹¶ç¡®ä¿è´¨é‡ - å­˜å‚¨åˆ°æ•°ç»„è€Œä¸æ˜¯ä¸‹è½½
      canvas.toBlob((blob) => {
          if (!blob) {
              console.error('PNGç”Ÿæˆå¤±è´¥');
              resolve();
              return;
          }
          
          console.log(`å¸§ ${frameNumber}: PNGå¤§å° ${blob.size} bytes`);
          
          // å­˜å‚¨å¸§æ•°æ®åˆ°æ•°ç»„
          const fileName = `frame_${frameNumber.toString().padStart(4, '0')}_alpha.png`;
          extractedFrames.push({
              blob: blob,
              filename: fileName
          });
          
          resolve();
      }, 'image/png', 1.0); // ç¡®ä¿æœ€é«˜è´¨é‡
    });
  }

  // é€å¸§æå–å‡½æ•°
  async function extractFrames() {
    if (!isExtracting) return;

    const currentTime = frameCount / fps;

    if (currentTime >= video.duration) {
      // æå–å®Œæˆ
      isExtracting = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      downloadBtn.disabled = false;
      status.textContent = `æå–å®Œæˆï¼å…±æå– ${frameCount} å¸§ï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®è·å–æ‰€æœ‰å¸§`;
      return;
    }

    // è®¾ç½®è§†é¢‘æ—¶é—´
    video.currentTime = currentTime;

    // ç­‰å¾…è§†é¢‘seekå®Œæˆ
    video.onseeked = async () => {
      await extractFrame(frameCount);
      frameCount++;

      status.textContent = `æ­£åœ¨æå–ç¬¬ ${frameCount} å¸§...`;
      frameInfo.textContent = `å¸§æ•°: ${frameCount} / æ—¶é—´: ${currentTime.toFixed(2)}s`;

      // å»¶è¿Ÿä¸€ç‚¹å†å¤„ç†ä¸‹ä¸€å¸§ï¼Œé¿å…è¿‡å¿«
      setTimeout(extractFrames, 100);
    };
  }

  // å¼€å§‹æå–
  startBtn.onclick = () => {
    if (video.readyState < 2) {
      status.textContent = "è§†é¢‘è¿˜æœªåŠ è½½å®Œæˆ";
      return;
    }

    isExtracting = true;
    frameCount = 0;
    extractedFrames = []; // æ¸…ç©ºä¹‹å‰çš„å¸§æ•°æ®
    startBtn.disabled = true;
    stopBtn.disabled = false;
    downloadBtn.disabled = true;
    status.textContent = "å¼€å§‹æå–å¸§...";

    video.pause(); // ç¡®ä¿è§†é¢‘æš‚åœ
    extractFrames();
  };

  // åœæ­¢æå–
  stopBtn.onclick = () => {
    isExtracting = false;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    if (extractedFrames.length > 0) {
      downloadBtn.disabled = false;
    }
    status.textContent = `æå–å·²åœæ­¢ï¼Œå·²æå– ${frameCount} å¸§`;
  };

  // ä¸‹è½½æ‰€æœ‰æå–çš„å¸§
  downloadBtn.onclick = async () => {
    if (extractedFrames.length === 0) {
      alert('æ²¡æœ‰å¯ä¸‹è½½çš„å¸§');
      return;
    }

    status.textContent = 'æ­£åœ¨æ‰“åŒ…ä¸‹è½½...';
    downloadBtn.disabled = true;

    try {
      // ä½¿ç”¨JSZipåº“æ‰“åŒ…æ–‡ä»¶
      const zip = new JSZip();
      
      // æ·»åŠ æ‰€æœ‰å¸§åˆ°ZIPæ–‡ä»¶
      for (let i = 0; i < extractedFrames.length; i++) {
        const frame = extractedFrames[i];
        zip.file(frame.filename, frame.blob);
      }

      // ç”ŸæˆZIPæ–‡ä»¶
      const zipBlob = await zip.generateAsync({type: "blob"});
      
      // ä¸‹è½½ZIPæ–‡ä»¶
      const link = document.createElement('a');
      link.href = URL.createObjectURL(zipBlob);
      link.download = `extracted_frames_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.zip`;
      link.click();
      
      setTimeout(() => URL.revokeObjectURL(link.href), 1000);
      
      status.textContent = `ä¸‹è½½å®Œæˆï¼å…± ${extractedFrames.length} å¸§å·²æ‰“åŒ…ä¸‹è½½`;
    } catch (error) {
      console.error('æ‰“åŒ…ä¸‹è½½å¤±è´¥:', error);
      status.textContent = 'æ‰“åŒ…ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
    } finally {
      downloadBtn.disabled = false;
    }
  };

  // é”™è¯¯å¤„ç†
  video.onerror = (e) => {
    console.error("è§†é¢‘åŠ è½½é”™è¯¯:", e);
    status.textContent = "è§†é¢‘åŠ è½½å¤±è´¥";
  };
</script>

</body>
</html>