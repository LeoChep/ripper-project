<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿå¸§æå–å™¨</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .controls { margin: 20px 0; display: flex; gap: 10px; align-items: center; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .primary { background: #007bff; color: white; }
        .danger { background: #dc3545; color: white; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .progress { margin: 10px 0; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; }
        .progress-bar { height: 100%; background: #007bff; width: 0%; transition: width 0.3s; }
        .info { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .info-item { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        video, canvas { max-width: 100%; border: 1px solid #ddd; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ¬ å¿«é€Ÿå¸§æå–å™¨</h1>
    
    <div class="controls">
        <input type="file" id="videoFile" accept="video/*">
        <label>FPS: <input type="number" id="fps" value="30" min="1" max="60" style="width:60px"></label>
        <button id="startBtn" class="primary" disabled>å¼€å§‹æå–</button>
        <button id="stopBtn" class="danger" disabled>åœæ­¢</button>
    </div>
    
    <div class="progress">
        <div id="progressBar" class="progress-bar"></div>
    </div>
    
    <div id="status">è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶</div>
    
    <div class="info">
        <div class="info-item">
            <div>å½“å‰å¸§</div>
            <div id="currentFrame">0</div>
        </div>
        <div class="info-item">
            <div>æ€»å¸§æ•°</div>
            <div id="totalFrames">0</div>
        </div>
        <div class="info-item">
            <div>å·²ä¸‹è½½</div>
            <div id="downloaded">0</div>
        </div>
    </div>
    
    <video id="video" muted style="display:none"></video>
    <canvas id="canvas" style="display:none"></canvas>
    
    <script>
        const elements = {
            videoFile: document.getElementById('videoFile'),
            video: document.getElementById('video'),
            canvas: document.getElementById('canvas'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            fps: document.getElementById('fps'),
            status: document.getElementById('status'),
            progressBar: document.getElementById('progressBar'),
            currentFrame: document.getElementById('currentFrame'),
            totalFrames: document.getElementById('totalFrames'),
            downloaded: document.getElementById('downloaded')
        };
        
        const ctx = elements.canvas.getContext('2d');
        let state = {
            isExtracting: false,
            frameCount: 0,
            totalFrames: 0,
            downloadCount: 0
        };
        
        // åŠ è½½è§†é¢‘æ–‡ä»¶
        elements.videoFile.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            elements.video.src = URL.createObjectURL(file);
            elements.status.textContent = "æ­£åœ¨åŠ è½½è§†é¢‘...";
        };
        
        // è§†é¢‘åŠ è½½å®Œæˆ
        elements.video.onloadedmetadata = function() {
            elements.canvas.width = this.videoWidth;
            elements.canvas.height = this.videoHeight;
            
            const fps = parseInt(elements.fps.value);
            state.totalFrames = Math.floor(this.duration * fps);
            
            elements.totalFrames.textContent = state.totalFrames;
            elements.startBtn.disabled = false;
            elements.status.textContent = `è§†é¢‘å·²åŠ è½½ (${this.videoWidth}x${this.videoHeight}, ${this.duration.toFixed(1)}s)`;
        };
        
        // å¼€å§‹æå–
        elements.startBtn.onclick = async function() {
            state.isExtracting = true;
            state.frameCount = 0;
            state.downloadCount = 0;
            
            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = false;
            elements.status.textContent = "å¼€å§‹æå–å¸§...";
            
            await extractAllFrames();
        };
        
        // åœæ­¢æå–
        elements.stopBtn.onclick = function() {
            state.isExtracting = false;
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            elements.status.textContent = `å·²åœæ­¢ - æå–äº† ${state.downloadCount} å¸§`;
        };
        
        // æå–æ‰€æœ‰å¸§
        async function extractAllFrames() {
            const fps = parseInt(elements.fps.value);
            
            while (state.isExtracting && state.frameCount < state.totalFrames) {
                await extractFrame(state.frameCount, fps);
                state.frameCount++;
                updateProgress();
                
                // æ¯5å¸§æš‚åœä¸€ä¸‹ï¼Œé¿å…é˜»å¡
                if (state.frameCount % 5 === 0) {
                    await sleep(10);
                }
            }
            
            if (state.isExtracting) {
                elements.status.textContent = `âœ… å®Œæˆï¼å…±æå– ${state.downloadCount} å¸§`;
                elements.startBtn.disabled = false;
                elements.stopBtn.disabled = true;
                state.isExtracting = false;
            }
        }
        
        // æå–å•å¸§
        function extractFrame(frameNumber, fps) {
            return new Promise((resolve) => {
                const time = frameNumber / fps;
                elements.video.currentTime = time;
                
                elements.video.onseeked = function() {
                    // ç»˜åˆ¶åˆ°canvas
                    ctx.drawImage(elements.video, 0, 0);
                    
                    // å¯¼å‡ºPNG
                    elements.canvas.toBlob(function(blob) {
                        if (blob) {
                            downloadBlob(blob, `frame_${frameNumber.toString().padStart(5, '0')}.png`);
                            state.downloadCount++;
                        }
                        resolve();
                    }, 'image/png', 0.9);
                };
            });
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            // æ¸…ç†URL
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const progress = (state.frameCount / state.totalFrames) * 100;
            elements.progressBar.style.width = progress + '%';
            elements.currentFrame.textContent = state.frameCount;
            elements.downloaded.textContent = state.downloadCount;
            elements.status.textContent = `æå–ç¬¬ ${state.frameCount} å¸§ (${progress.toFixed(1)}%)`;
        }
        
        // å»¶è¿Ÿå‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
